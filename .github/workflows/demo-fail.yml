name: Fail Job with Notification
on:
  push:
    branches:
      - main
jobs:
  fail-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Force failure
        run: |
          echo "Simulating failure..."
          echo "This is a debug message before failure" >&2
          exit 1
        id: failure-step
      
      - name: Capture logs
        if: always()
        run: |
          echo "Capturing logs..."
          {
            echo "GITHUB_WORKFLOW: $GITHUB_WORKFLOW"
            echo "GITHUB_ACTION: $GITHUB_ACTION"
            echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
            echo "GITHUB_SHA: $GITHUB_SHA"
            echo "GITHUB_REF: $GITHUB_REF"
            echo "Step outputs:"
            echo "${{ toJson(steps) }}"
          } > job_logs.txt
      
      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: job-logs
          path: job_logs.txt
  
  failure-notification:
    runs-on: ubuntu-latest
    needs: fail-job
    if: always()
    steps:
      - name: Download logs artifact
        uses: actions/download-artifact@v3
        with:
          name: job-logs
      
      - name: Read logs and send notification
        run: |
          LOGS=$(cat job_logs.txt)
          echo "Logs content:"
          echo "$LOGS"
          ESCAPED_LOGS=$(echo "$LOGS" | jq -sRr @json)
          
          echo "Sending full payload to webhook:"
          curl -v -X POST -H "Content-Type: application/json" \
          -d "{\"text\": \"GitHub Action failed in fail-job. Logs: $ESCAPED_LOGS\"}" \
          https://webhooksource-kubiya.hooks.kubiya.ai:8443/NFg08dN_1RNBZ-MP4M5fClwTEuCcyFoDttLQTj8xgOnSCbtqLPhuVfHkWnvXiKXlroILiWVL237h2yuyBeg7KA== > webhook_response_full.txt
          
          echo "Webhook Response (Full Payload):"
          cat webhook_response_full.txt
          
          echo "Sending simplified payload to webhook:"
          curl -v -X POST -H "Content-Type: application/json" \
          -d "{\"text\": \"Test message from GitHub Action\"}" \
          https://webhooksource-kubiya.hooks.kubiya.ai:8443/NFg08dN_1RNBZ-MP4M5fClwTEuCcyFoDttLQTj8xgOnSCbtqLPhuVfHkWnvXiKXlroILiWVL237h2yuyBeg7KA== > webhook_response_simple.txt
          
          echo "Webhook Response (Simplified Payload):"
          cat webhook_response_simple.txt